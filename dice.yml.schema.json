{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "id": "https://erda.cloud/schemas/dice.yml/schema",
  "title": "Erda dice.yml Schema",
  "type": "object",
  "properties": {
    "$schema": {
      "type": "string"
    },
    "version": {
      "type": "string"
    },
    "meta": {
      "type": "object",
      "description": "dice.yml 的元数据",
      "additionalProperties": {
        "type": "string"
      }
    },
    "envs": {
      "description": "全局环境变量, 优先级低于 service 或 job 自身的环境变量",
      "$ref": "#/definitions/EnvMap"
    },
    "services": {
      "description": "定义各服务",
      "$ref": "#/definitions/Services"
    },
    "jobs": {
      "$ref": "#/definitions/Jobs"
    },
    "addons": {
      "$ref": "#/definitions/AddOns"
    },
    "environments": {
      "description": "如果各环境有环境变量, Services, Addons 定义有差异, 可以在此处进行差异化定义",
      "$ref": "#/definitions/EnvObjects"
    },
    "values": {
      "description": "各环境的 key-value, 可以在其他值中引用",
      "$ref": "#/definitions/ValueObjects"
    }
  },
  "oneOf": [
    {
      "description": "services 与 jobs 不能同时存在于一个 dice.yml 中",
      "required": [
        "services"
      ]
    },
    {
      "description": "services 与 jobs 不能同时存在于一个 dice.yml 中",
      "required": [
        "jobs"
      ]
    }
  ],
  "description": "services 与 jobs 不能同时存在于一个 dice.yml 中",
  "additionalProperties": false,
  "definitions": {
    "Services": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/Service"
      }
    },
    "Service": {
      "type": "object",
      "properties": {
        "image": {
          "description": "服务镜像",
          "type": "string"
        },
        "image_username": {
          "description": "拉取镜像的用户名",
          "type": "string"
        },
        "image_password": {
          "description": "拉取镜像的密码",
          "type": "string"
        },
        "cmd": {
          "description": "启动命令, 不填则按镜像的 Entrypoint 启动",
          "type": "string"
        },
        "ports": {
          "description": "要启用的端口",
          "type": "array",
          "items": {
            "$ref": "#/definitions/ServicePort"
          }
        },
        "envs": {
          "$ref": "#/definitions/EnvMap"
        },
        "hosts": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "resources": {
          "description": "服务 (Pod) 使用的资源",
          "$ref": "#/definitions/Resources"
        },
        "labels": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "annotations": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "binds": {
          "description": "文件挂载",
          "$ref": "#/definitions/Binds"
        },
        "volumes": {
          "$ref": "#/definitions/Volumes"
        },
        "deployments": {
          "$ref": "#/definitions/Deployments"
        },
        "depends_on": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "expose": {
          "type": "array",
          "items": {
            "type": "integer",
            "default": 8080
          }
        },
        "health_check": {
          "$ref": "#/definitions/HealthCheck"
        },
        "sidecars": {
          "type": "object",
          "patternProperties": {
            "^[A-za-z].*": {
              "$ref": "#/definitions/SideCar"
            }
          }
        },
        "init": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/InitContainer"
          }
        },
        "mesh_enable": {
          "type": "boolean",
          "deprecationMessage": "Erda 已不支持该功能"
        },
        "traffic_security": {
          "$ref": "#/definitions/TrafficSecurity"
        },
        "endpoints": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Endpoint"
          }
        },
        "k8s_snippet": {
          "$ref": "#/definitions/K8SSnippet"
        }
      }
    },
    "ServicePort": {
      "type": "object",
      "properties": {
        "port": {
          "description": "启用的端口号",
          "type": "integer",
          "default": 8080
        },
        "protocol": {
          "type": "string",
          "description": "4/7 层网络协议",
          "default": "TCP"
        },
        "l4_protocol": {
          "type": "string",
          "description": "4 层网络协议",
          "enum": [
            "TCP",
            "UDP"
          ],
          "default": "TCP"
        },
        "expose": {
          "type": "boolean",
          "default": false
        },
        "default": {
          "type": "boolean",
          "default": false
        }
      }
    },
    "EnvMap": {
      "type": "object",
      "patternProperties": {
        "^[A-Z][A-Z0-9_]*$": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "integer"
            },
            {
              "type": "number"
            },
            {
              "type": "boolean"
            }
          ]
        }
      }
    },
    "Resources": {
      "description": "可以用 cpu: ${request_cpu:1} 引用 values 和设置默认值",
      "type": "object",
      "properties": {
        "cpu": {
          "anyOf": [
            {
              "type": "number"
            },
            {
              "type": "string"
            }
          ],
          "description": "CPU 核心数, 对应 K8s 中 request 值.\n可以用 ${request_cpu:1} 引用 values 和设置默认值",
          "examples": ["${request_cpu:1}"],
          "default": 1
        },
        "mem": {
          "anyOf": [
            {
              "type": "integer"
            },
            {
              "type": "string"
            }
          ]
        },
        "max_cpu": {
          "type": "number"
        },
        "max_mem": {
          "type": "integer"
        },
        "disk": {
          "type": "integer"
        },
        "network": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "emptydir_size": {
          "type": "integer"
        },
        "ephemeral_storage_size": {
          "type": "integer"
        }
      }
    },
    "Binds": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "Jobs": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/Job"
      }
    },
    "AddOns": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/AddOn"
      }
    },
    "ValueObjects": {
      "type": "object",
      "patternProperties": {
        "development|test|staging|production": {
          "$ref": "#/definitions/ValueMap"
        }
      }
    },
    "Volume": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string"
        },
        "storage": {
          "type": "string"
        },
        "path": {
          "type": "string"
        },
        "type": {
          "type": "string"
        },
        "size": {
          "type": "integer"
        },
        "targetPath": {
          "type": "string"
        },
        "readOnly": {
          "type": "boolean"
        },
        "snapshot": {
          "$ref": "#/definitions/VolumeSnapshot"
        }
      }
    },
    "Deployments": {
      "type": "object",
      "properties": {
        "replicas": {
          "anyOf": [
            {
              "type": "integer"
            },
            {
              "type": "string"
            }
          ]
        },
        "policies": {
          "type": "string"
        },
        "labels": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "workload": {
          "type": "string"
        },
        "selectors": {
          "$ref": "#/definitions/Selectors"
        }
      }
    },
    "HealthCheck": {
      "type": "object",
      "properties": {
        "http": {
          "$ref": "#/definitions/HTTPCheck"
        },
        "exec": {
          "$ref": "#/definitions/ExecCheck"
        }
      }
    },
    "SideCar": {
      "type": "object",
      "properties": {
        "image": {
          "type": "string"
        },
        "cmd": {
          "type": "string"
        },
        "envs": {
          "$ref": "#/definitions/EnvMap"
        },
        "resources": {
          "$ref": "#/definitions/Resources"
        }
      }
    },
    "InitContainer": {
      "type": "object",
      "properties": {
        "image": {
          "type": "string"
        },
        "shared_dir": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/SharedDir"
          }
        },
        "cmd": {
          "type": "string"
        },
        "resources": {
          "$ref": "#/definitions/Resources"
        }
      }
    },
    "TrafficSecurity": {
      "type": "object",
      "properties": {
        "mode": {
          "type": "string"
        }
      }
    },
    "Endpoint": {
      "type": "object",
      "properties": {
        "domain": {
          "type": "string"
        },
        "path": {
          "type": "string"
        },
        "backend_path": {
          "type": "string"
        },
        "policies": {
          "$ref": "#/definitions/EndpointPolicies"
        }
      }
    },
    "K8SSnippet": {
      "type": "object",
      "properties": {
        "container": {
          "$ref": "#/definitions/ContainerSnippet"
        }
      }
    },
    "Job": {
      "type": "object",
      "properties": {
        "image": {
          "type": "string"
        },
        "cmd": {
          "type": "string"
        },
        "envs": {
          "$ref": "#/definitions/EnvMap"
        },
        "resources": {
          "$ref": "#/definitions/Resources"
        },
        "labels": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "binds": {
          "$ref": "#/definitions/Binds"
        },
        "volumes": {
          "$ref": "#/definitions/Volumes"
        },
        "init": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/InitContainer"
          }
        },
        "hosts": {
          "type": "string",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "Volumes": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Volume"
      }
    },
    "AddOn": {
      "type": "object",
      "properties": {
        "plan": {
          "type": "string"
        },
        "as": {
          "type": "string"
        },
        "options": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "actions": {
          "type": "object",
          "additionalProperties": true
        },
        "image": {
          "type": "string"
        }
      }
    },
    "ValueMap": {
      "type": "object",
      "additionalProperties": {
        "anyOf": [
          {
            "type": "string"
          },
          {
            "type": "integer"
          },
          {
            "type": "number"
          },
          {
            "type": "boolean"
          }
        ]
      }
    },
    "VolumeSnapshot": {
      "type": "object",
      "properties": {
        "maxHistory": {
          "type": "integer"
        }
      }
    },
    "Selectors": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/Selector"
      }
    },
    "HTTPCheck": {
      "type": "object",
      "properties": {
        "port": {
          "type": "integer"
        },
        "path": {
          "type": "string"
        },
        "duration": {
          "type": "integer"
        }
      }
    },
    "ExecCheck": {
      "type": "object",
      "properties": {
        "cmd": {
          "type": "string"
        },
        "duration": {
          "type": "integer"
        }
      }
    },
    "SharedDir": {
      "type": "object",
      "properties": {
        "main": {
          "type": "string"
        },
        "sidecar": {
          "type": "string"
        }
      }
    },
    "EndpointPolicies": {
      "type": "object",
      "properties": {
        "cors": {
          "type": "object",
          "additionalProperties": true
        },
        "rate_limit": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },
    "Selector": {
      "type": "object",
      "properties": {
        "not": {
          "type": "boolean"
        },
        "values": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "ContainerSnippet": {
      "description": "k8s.io/api/core/v1.Container",
      "type": "object",
      "additionalProperties": true
    },
    "EnvObjects": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/EnvObject"
      }
    },
    "EnvObject": {
      "type": "object",
      "properties": {
        "envs": {
          "$ref": "#/definitions/EnvMap"
        },
        "services": {
          "$ref": "#/definitions/Services"
        },
        "addons": {
          "$ref": "#/definitions/AddOns"
        }
      }
    }
  }
}