{
  "name": "应用NodeJS堆内存使用率",
  "alert_scope": "micro_service",
  "attributes": {
    "level": "WARNING",
    "recover": "false",
    "display_url_id": "micro_nodejs",
    "alert_group": "{{terminus_key}}-{{instance_id}}",
    "tickets_metric_key": "{{instance_id}}"
  },
  "template": {
    "metric": "nodejs_memory",
    "window": 1,
    "filters": [
      {
        "tag": "terminus_key",
        "operator": "eq",
        "value": "$terminus_key"
      },
      {
        "tag": "application_id",
        "operator": "in",
        "value": ["$application_id"]
      }
    ],
    "group": [
      "instance_id"
    ],
    "functions": [
      {
        "aggregator": "avg",
        "field": "usage_percent",
        "field_script": "function invoke(field, tag){ if(!field.max) { return 0; } return field.rss / field.max * 100; }",
        "operator": "gte",
        "value": 75
      },
      {
        "aggregator": "max",
        "alias": "heap_used_value",
        "field": "heap_used"
      },
      {
        "aggregator": "max",
        "alias": "heap_total_value",
        "field": "heap_total"
      },
      {
        "aggregator": "max",
        "alias": "rss_value",
        "field": "rss"
      },
      {
        "aggregator": "max",
        "alias": "max_value",
        "field": "max"
      }
    ],
    "select": {
      "application_id": "#application_id",
      "application_name": "#application_name",
      "cluster_name": "#cluster_name",
      "host_ip": "#host_ip",
      "instance_id": "#instance_id",
      "project_id": "#project_id",
      "project_name": "#project_name",
      "runtime_id": "#runtime_id",
      "runtime_name": "#runtime_name",
      "service_name": "#service_name",
      "terminus_key": "#terminus_key",
      "workspace": "#workspace"
    },
    "outputs": [
      "alert"
    ]
  }
}