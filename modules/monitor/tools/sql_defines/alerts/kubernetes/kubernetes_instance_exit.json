{
  "name": "kubernetes组件异常退出",
  "alert_scope": "org",
  "attributes": {
    "level": "WARNING",
    "recover": "false",
    "display_url_id": "org_pod",
    "alert_group": "{{cluster_name}}-{{container_id}}",
    "tickets_metric_key": "{{container_id}}"
  },
  "template": {
    "metrics": ["docker_container_summary"],
    "window": 1,
    "filters": [
      {
        "tag": "cluster_name",
        "operator": "in",
        "value": ["$cluster_name"]
      },
      {
        "tag": "pod_namespace",
        "operator": "eq",
        "value": "kube-system"
      }
    ],
    "group": [
      "cluster_name",
      "pod_namespace",
      "pod_name"
    ],
    "functions": [
      {
        "aggregator": "max",
        "field": "exitcode",
        "operator": "gt",
        "value": 0
      },
      {
        "aggregator": "max",
        "field": "oomkilled"
      },
      {
        "aggregator": "value",
        "field": "pid"
      },
      {
        "aggregator": "max",
        "field": "finished_at",
        "field_script": "function invoke(fields,tags){if(fields.finished_at!=null&&fields.finished_at!=undefined) return fields.finished_at/1000000;return 0}"
      },
      {
        "aggregator": "max",
        "field": "started_at",
        "field_script": "function invoke(fields,tags){if(fields.started_at!=null&&fields.started_at!=undefined) return fields.started_at/1000000;return 0}"
      },
      {
        "aggregator": "value",
        "trigger": "aggregated",
        "field": "finished_at",
        "field_script": "function invoke(fields,tags){if(fields.finished_at_max>0) return fields.finished_at_max;return '-'}"
      },
      {
        "aggregator": "value",
        "trigger": "aggregated",
        "field": "started_at",
        "field_script": "function invoke(fields,tags){if(fields.started_at_max>0) return fields.started_at_max;return '-'}"
      },
      {
        "aggregator": "value",
        "field": "terminated_reason",
        "trigger": "aggregated",
        "field_script": "function invoke(fields,tags){if(fields.oomkilled) return 'Out Of Memory';return 'Error Exit Code '+fields.exitcode_max;}"
      }
    ],
    "select": {
      "cluster_name": "#cluster_name",
      "host_ip": "#host_ip",
      "pod_namespace": "#pod_namespace",
      "pod_name": "#pod_name",
      "container_id": "#container_id",
      "component_name": "#component_name",
      "_meta": "#_meta",
      "_metric_scope": "#_metric_scope",
      "_metric_scope_id": "#_metric_scope_id",
      "org_name": "#org_name"
    },
    "outputs": [
      "alert"
    ]
  }
}
