{
  "name": "服务接口HTTP错误率异常",
  "alert_scope": "micro_service",
  "attributes": {
    "level": "WARNING",
    "recover": "false",
    "display_url_id": "micro_si_web",
    "alert_group": "{{target_terminus_key}}-{{target_runtime_id}}-{{target_service_name}}-{{http_path}}-{{http_method}}",
    "tickets_metric_key": "{{target_application_id}}"
  },
  "template": {
    "metric": "application_http",
    "window": 1,
    "filters": [{
        "tag": "target_terminus_key",
        "operator": "eq",
        "value": "$target_terminus_key"
      },
      {
        "tag": "target_application_id",
        "operator": "in",
        "value": ["$target_application_id"]
      }
    ],
    "group": [
      "target_runtime_id",
      "target_service_name",
      "http_path",
      "http_method"
    ],
    "functions": [{
        "field": "elapsed_count",
        "aggregator": "sum",
        "operator": "gte",
        "value": 10
      },
      {
        "field": "error_count",
        "aggregator": "sum",
        "field_script": "function invoke(field, tag){ if(field.http_status_code_mean < 500) { return 0; } return field.elapsed_count; }"
      },
      {
        "aggregator": "value",
        "field": "error_percent",
        "field_script": "function invoke(field, tag){ if(!field.elapsed_count_sum) return 0; return field.elapsed_count_sum === 0 ? 0 : (field.error_count_sum / field.elapsed_count_sum * 100);}",
        "operator": "gte",
        "trigger": "aggregated",
        "value": 50
      }
    ],
    "condition": "and",
    "select": {
      "application_id": "#target_application_id",
      "application_name": "#target_application_name",
      "project_id": "#target_project_id",
      "project_name": "#target_project_name",
      "runtime_id": "#target_runtime_id",
      "runtime_name": "#target_runtime_name",
      "service_name": "#target_service_name",
      "terminus_key": "#target_terminus_key",
      "workspace": "#target_workspace",
      "http_path": "#http_path",
      "http_method": "#http_method",
      "http_url": "#http_url"
    },
    "outputs": [
      "alert"
    ]
  }
}