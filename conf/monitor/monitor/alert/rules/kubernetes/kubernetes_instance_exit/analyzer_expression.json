{
  "id":"kubernetes_instance_exit",
  "expression":{
    "filters":[
      {
        "operator":"eq",
        "tag":"org_name",
        "value":"$org_name"
      },
      {
        "operator":"eq",
        "tag":"pod_namespace",
        "value":"kube-system"
      }
    ],
    "functions":[
      {
        "aggregator":"max",
        "field":"exitcode",
        "operator":"gt",
        "value":0
      },
      {
        "aggregator":"max",
        "field":"oomkilled"
      },
      {
        "aggregator":"value",
        "field":"pid"
      },
      {
        "aggregator":"max",
        "field":"finished_at",
        "field_script":"function invoke(fields,tags){if(fields.finished_at!=null\u0026\u0026fields.finished_at!=undefined) return fields.finished_at/1000000;return 0}"
      },
      {
        "aggregator":"max",
        "field":"started_at",
        "field_script":"function invoke(fields,tags){if(fields.started_at!=null\u0026\u0026fields.started_at!=undefined) return fields.started_at/1000000;return 0}"
      },
      {
        "aggregator":"value",
        "field":"finished_at",
        "field_script":"function invoke(fields,tags){if(fields.finished_at_max\u003e0) return fields.finished_at_max;return '-'}",
        "trigger":"aggregated"
      },
      {
        "aggregator":"value",
        "field":"started_at",
        "field_script":"function invoke(fields,tags){if(fields.started_at_max\u003e0) return fields.started_at_max;return '-'}",
        "trigger":"aggregated"
      },
      {
        "aggregator":"value",
        "field":"terminated_reason",
        "field_script":"function invoke(fields,tags){if(fields.oomkilled) return 'Out Of Memory';return 'Error Exit Code '+fields.exitcode_max;}",
        "trigger":"aggregated"
      }
    ],
    "group":[
      "cluster_name",
      "pod_namespace",
      "pod_name"
    ],
    "metrics":[
      "docker_container_summary"
    ],
    "outputs":[
      "alert"
    ],
    "select":{
      "_meta":"#_meta",
      "_metric_scope":"#_metric_scope",
      "_metric_scope_id":"#_metric_scope_id",
      "cluster_name":"#cluster_name",
      "component_name":"#component_name",
      "container_id":"#container_id",
      "host_ip":"#host_ip",
      "org_name":"#org_name",
      "pod_ip":"#pod_ip",
      "pod_name":"#pod_name",
      "pod_namespace":"#pod_namespace"
    },
    "window":1
  }
}
